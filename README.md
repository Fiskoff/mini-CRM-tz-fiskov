# Mini CRM

Мини-CRM система для управления обращениями клиентов и их распределения между операторами.

## Запуск проекта

Для запуска проекта выполните следующую команду:

```
uvicorn main:main_app --host 0.0.0.0 --port 8000
```

Также можно запустить через docker-compose:

```
docker-compose up --build
```

## Модель данных

Система состоит из следующих основных сущностей:

1. **Lead (Лид)** - представляет собой клиента или потенциального клиента. Имеет уникальный идентификатор, номер телефона и email. Один лид может иметь несколько контактов.

2. **Contact (Контакт)** - представляет собой обращение от лида через определенный источник. Каждый контакт привязан к лиду, источнику и может быть назначен оператору.

3. **Source (Источник)** - источник обращений (например, сайт, колл-центр, соцсети и т.д.).

4. **Operator (Оператор)** - сотрудник, который обрабатывает обращения. Может быть активным или неактивным, имеет максимальную нагрузку (max_load).

5. **SourceOperatorDistribution (Правила распределения)** - определяет правила распределения обращений от источника между операторами с учетом весов.

Связи между сущностями:
- Один Lead может иметь много Contacts
- Каждый Contact принадлежит одному Lead, одному Source и может быть назначен одному Operator
- Один Source может иметь много Contacts и много правил распределения
- Один Operator может обрабатывать много Contacts и иметь много правил распределения
- SourceOperatorDistribution связывает Source и Operator с определенным весом (weight)

## Алгоритм распределения

### Определение принадлежности обращений одному лиду

Обращения считаются принадлежащими одному лиду, если совпадает хотя бы один из следующих параметров:
- Внешний идентификатор (external_id)
- Номер телефона (phone)
- Email адрес (email)

При регистрации нового контакта система проверяет наличие лида по этим полям. Если лид не найден, создается новый.

### Учет весов операторов по источникам

Для каждого источника можно задать правила распределения в таблице `source_operator_distributions`. Каждое правило содержит:
- Ссылку на источник
- Ссылку на оператора
- Вес (weight) - число от 0.01 до 999.99

Чем больше вес, тем выше вероятность, что оператор получит обращение от этого источника.

### Учет лимитов нагрузки

У каждого оператора есть параметр `max_load` - максимальное количество активных контактов, которые он может обрабатывать одновременно.

При распределении система проверяет текущую нагрузку оператора, подсчитывая количество активных контактов (`is_active = True`). Если текущая нагрузка меньше `max_load`, оператор считается доступным для получения новых обращений.

### Что происходит, если подходящих операторов нет

Если подходящих операторов нет (все имеют максимальную нагрузку или не активны), то:
1. Обращение регистрируется без назначения оператора (поле `operator_id` остается NULL)
2. В ответе API указывается, что оператор недоступен
3. Позже, когда появится свободный оператор, можно будет вручную назначить его на обращение

Алгоритм выбора оператора работает следующим образом:
1. Получаем все правила распределения для данного источника
2. Фильтруем операторов: оставляем только активных и тех, у кого нагрузка ниже допустимой
3. Рассчитываем вероятности на основе весов
4. Случайным образом выбираем одного оператора с учетом весов